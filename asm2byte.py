#!/usr/bin/env python

import sys
import subprocess

if (len(sys.argv) != 2):
    print("Usage: ./asm2byte.py [.asm file]")

else:
    #extract code file name
    asm_name = sys.argv[1]

    if (asm_name.find(".asm") == -1):
        print("Error: not .asm file")
        sys.exit()

    file_name = asm_name[0:sys.argv[1].find(".asm")]

    #compile
    subprocess.call(["nasm",  "-f", "elf", asm_name])
    #link
    subprocess.call(["ld", "-m", "elf_i386", "-o", file_name, file_name + ".o"])
    #get bytes
    process = subprocess.Popen(["objdump", "-s", file_name], stdout=subprocess.PIPE)
    out, err = process.communicate()
    #trim
    lines = out.splitlines()
    lines = lines[4:] #remove header
    bytes = ""
    for line in lines:
        line = line[line.find(" ", 1):45] #remove address and ascii
        bytes = bytes + line
    bytes = bytes.replace(" ", "")
    num_bytes = len(bytes)/2

    #format for copying
    formatted = ""
    i = 0
    while (i < len(bytes)):
        formatted = formatted + r"\x" + bytes[i:i+2]
        i += 2
    print("bytecode (" + str(num_bytes) + " bytes):\n" + formatted)
